<mxfile host="app.diagrams.net" modified="2026-01-10T20:20:00.000Z" agent="GPT" version="24.7.17" type="device">
  <diagram id="arch" name="Architecture - Components & Locations">
    <mxGraphModel dx="1200" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="850" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Title -->
        <mxCell id="t1" value="ClaruSigna Bot Milestone Architecture (GitHub Pages + Cloudflare Workers + AI Search)" style="text;html=1;align=left;verticalAlign=top;resizable=0;whiteSpace=wrap;rounded=0;fontSize=18;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="10" width="1020" height="40" as="geometry"/>
        </mxCell>

        <!-- User -->
        <mxCell id="u1" value="End User&#xa;(Browser)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="110" width="170" height="70" as="geometry"/>
        </mxCell>

        <!-- GitHub Pages / Site -->
        <mxCell id="s1" value="clarsusigna.com&#xa;GitHub Pages (static site)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="260" y="90" width="260" height="110" as="geometry"/>
        </mxCell>

        <mxCell id="s2" value="bot.js (front-end)&#xa;- UI chat widget&#xa;- POSTs messages to Worker&#xa;- optional debug flag" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="285" y="215" width="210" height="90" as="geometry"/>
        </mxCell>

        <!-- Cloudflare Worker -->
        <mxCell id="w1" value="Cloudflare Worker&#xa;clarusigna-bot-worker.hapincham.workers.dev" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="590" y="90" width="350" height="120" as="geometry"/>
        </mxCell>

        <mxCell id="w2" value="Worker responsibilities&#xa;- CORS allow-list for https://clarusigna.com&#xa;- parse messages[]&#xa;- extract latest user query&#xa;- call AI Search (env.AI.autorag)&#xa;- return {text} (+ debug payload when enabled)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="610" y="225" width="310" height="130" as="geometry"/>
        </mxCell>

        <!-- AI Search -->
        <mxCell id="a1" value="Cloudflare AI Search (AutoRAG)&#xa;Instance: clarus-search" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="590" y="390" width="350" height="90" as="geometry"/>
        </mxCell>

        <!-- R2 -->
        <mxCell id="r1" value="Cloudflare R2 Bucket&#xa;Knowledge base&#xa;- PDFs&#xa;- Markdown (ABOUT.md, SERVICES.md, etc.)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="260" y="420" width="260" height="110" as="geometry"/>
        </mxCell>

        <mxCell id="r2" value="Keys / prefixes&#xa;clarusigna/ABOUT.md&#xa;clarusigna/GUARDRAILS.md&#xa;clarusigna/... (more)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#b85450;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="285" y="545" width="210" height="90" as="geometry"/>
        </mxCell>

        <!-- KV (optional but recommended) -->
        <mxCell id="k1" value="Cloudflare KV (optional)&#xa;Editable prompt storage&#xa;Binding: PROMPTS&#xa;Key: system_prompt" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="590" y="510" width="350" height="90" as="geometry"/>
        </mxCell>

        <!-- Observability -->
        <mxCell id="o1" value="Observability / Logs&#xa;(Cloudflare dashboard)&#xa;- request traces&#xa;- errors&#xa;- indexing/job logs (AI Search)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#666666;fontSize=12;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="590" y="630" width="350" height="90" as="geometry"/>
        </mxCell>

        <!-- Edges -->
        <mxCell id="e1" value="HTTPS GET" style="endArrow=block;html=1;rounded=0;fontSize=11;" edge="1" parent="1" source="u1" target="s1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e2" value="HTTPS POST (messages + optional debug)" style="endArrow=block;html=1;rounded=0;fontSize=11;" edge="1" parent="1" source="s2" target="w1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e3" value="env.AI.autorag(&quot;clarus-search&quot;).aiSearch()" style="endArrow=block;html=1;rounded=0;fontSize=11;" edge="1" parent="1" source="w1" target="a1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e4" value="Index / retrieve" style="endArrow=block;html=1;rounded=0;fontSize=11;" edge="1" parent="1" source="a1" target="r1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e5" value="Read system_prompt (optional)" style="endArrow=block;html=1;rounded=0;fontSize=11;dashed=1;" edge="1" parent="1" source="w1" target="k1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e6" value="Logs / metrics" style="endArrow=block;html=1;rounded=0;fontSize=11;dashed=1;" edge="1" parent="1" source="w1" target="o1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e7" value="Logs / indexing status" style="endArrow=block;html=1;rounded=0;fontSize=11;dashed=1;" edge="1" parent="1" source="a1" target="o1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Group labels -->
        <mxCell id="g1" value="Client" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="170" height="30" as="geometry"/>
        </mxCell>

        <mxCell id="g2" value="Web Hosting" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="260" y="60" width="260" height="30" as="geometry"/>
        </mxCell>

        <mxCell id="g3" value="Cloudflare Platform" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="590" y="60" width="350" height="30" as="geometry"/>
        </mxCell>

        <mxCell id="g4" value="Storage" style="text;html=1;align=left;verticalAlign=top;whiteSpace=wrap;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="260" y="390" width="260" height="30" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>

  <diagram id="flow" name="Runtime Flow - Request, Retrieval, Response">
    <mxGraphModel dx="1200" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="850" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Title -->
        <mxCell id="ft1" value="Runtime Flow (User question → Worker → AI Search → Answer)" style="text;html=1;align=left;verticalAlign=top;resizable=0;whiteSpace=wrap;rounded=0;fontSize=18;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="10" width="1020" height="40" as="geometry"/>
        </mxCell>

        <!-- Swimlane-ish columns -->
        <mxCell id="col1" value="Browser (clarsusigna.com)" style="swimlane;html=1;rounded=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="70" width="300" height="730" as="geometry"/>
        </mxCell>
        <mxCell id="col2" value="Cloudflare Worker" style="swimlane;html=1;rounded=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="380" y="70" width="320" height="730" as="geometry"/>
        </mxCell>
        <mxCell id="col3" value="AI Search + Index" style="swimlane;html=1;rounded=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="740" y="70" width="320" height="730" as="geometry"/>
        </mxCell>

        <!-- Steps: Browser -->
        <mxCell id="b1" value="1) User types message&#xa;(chat input)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="70" y="140" width="240" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="b2" value="2) bot.js builds payload&#xa;- messages[]&#xa;- debug (optional)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="70" y="230" width="240" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="b3" value="3) POST to Worker URL&#xa;Content-Type: application/json" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="70" y="330" width="240" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="b4" value="8) Render response&#xa;- show text only&#xa;- debug data stays hidden" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="70" y="650" width="240" height="70" as="geometry"/>
        </mxCell>

        <!-- Steps: Worker -->
        <mxCell id="wstep1" value="4) Validate request&#xa;- CORS origin allow-list&#xa;- method POST&#xa;- parse JSON" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="410" y="160" width="260" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="wstep2" value="5) Build query&#xa;- find latest user message&#xa;- set system_prompt (guardrails)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="410" y="270" width="260" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="wstep3" value="6) Call AI Search&#xa;env.AI.autorag(&quot;clarus-search&quot;).aiSearch({query,...})" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="410" y="370" width="260" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="wstep4" value="7) Return JSON&#xa;- {text} to users&#xa;- {text,sources,result} only when debug=true (redacted)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="410" y="540" width="260" height="90" as="geometry"/>
        </mxCell>

        <!-- Steps: AI Search -->
        <mxCell id="astep1" value="6a) Retrieve matches&#xa;- vector search over indexed R2 objects&#xa;- returns top files + scores" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="770" y="200" width="260" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="astep2" value="6b) Synthesize answer&#xa;- grounded on retrieved chunks&#xa;- returns response + metadata" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="770" y="310" width="260" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="astep3" value="Index Source: R2&#xa;- PDFs + Markdown&#xa;- keys like clarusigna/ABOUT.md" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="770" y="430" width="260" height="80" as="geometry"/>
        </mxCell>

        <!-- Edges -->
        <mxCell id="fe1" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="b1" target="b2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe2" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="b2" target="b3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe3" value="POST /" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="b3" target="wstep1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe4" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="wstep1" target="wstep2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe5" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="wstep2" target="wstep3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe6" value="aiSearch" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="wstep3" target="astep1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe7" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="astep1" target="astep2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe8" value="retrieves/indexed content" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="astep1" target="astep3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe9" value="result + response" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="astep2" target="wstep4">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="fe10" value="JSON {text}" style="endArrow=block;html=1;fontSize=11;" edge="1" parent="1" source="wstep4" target="b4">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
